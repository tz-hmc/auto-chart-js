const t=location.origin,o=e=>+e/16*1e3,c=e=>e/1e3/(1/16),i=e=>new URL(e,t);let s=i("");s.protocol="ws:";class e{constructor(e,t,s,i,a,r,n,o,c){this.svgPath=new Path2D(e),this.keySvgPath=new Path2D(t),this.keyCode=s,this.color=i,this.longNoteColor=a,this.keyColor=r,this.outlineColor=n,this.xOff=o,this.yOff=c}drawKey(e,t,s,i=!1){e.save(),e.translate(t-this.xOff,s-this.yOff),e.scale(.2,.2),i?(e.fillStyle="#ffffff",e.fill(this.keySvgPath),e.strokeStyle=this.color,e.lineWidth=5,e.stroke(this.keySvgPath)):(e.fillStyle=this.keyColor,e.fill(this.keySvgPath)),e.restore()}drawNote(e,t,s){e.save(),e.translate(t-this.xOff,s-this.yOff),e.scale(.2,.2),e.fillStyle=this.color,e.fill(this.svgPath),e.strokeStyle=this.outlineColor,e.lineWidth=10,e.stroke(this.svgPath),e.restore()}drawLongNote(e,t,s,i){this.drawNote(e,t,s);s+=12,i=s+45*i;e.beginPath(),e.moveTo(t,s),e.lineTo(t,i),e.lineCap="round",e.strokeStyle=this.longNoteColor,e.lineWidth=24,e.stroke(),e.closePath()}}const a=[new e("M451.4,195.4H231.9l48-48c23.7-23.7,23.7-62.1,0-85.7c-23.7-23.7-62-23.7-85.7,0L0,256l194.3,194.3   c11.8,11.8,27.3,17.8,42.8,17.8c15.5,0,31-5.9,42.8-17.8c23.7-23.7,23.7-62.1,0-85.7l-48-48h219.5c33.4,0,60.6-27.1,60.6-60.6   C512,222.5,484.9,195.4,451.4,195.4z","M245,467.7c-21.2,0-41.2-8.3-56.2-23.3L0,255.6L188.8,66.9c30-30.1,82.4-30.1,112.5,0c15,14.9,23.3,34.9,23.3,56.2   c0,19.8-7.2,38.5-20.3,53.1h128.2c43.8,0,79.5,35.7,79.5,79.5c0,43.9-35.7,79.5-79.5,79.5H304.3c13.1,14.5,20.3,33.2,20.3,53   c0.1,21.3-8.3,41.3-23.3,56.3C286.2,459.4,266.2,467.7,245,467.7z M75,255.6l151.3,151.3c10,10,27.4,10,37.5,0   c5-5,7.8-11.7,7.8-18.8c0-7.1-2.8-13.7-7.7-18.7l-87.3-87.3h256c14.6,0,26.5-11.9,26.5-26.5c0-14.6-11.9-26.5-26.5-26.5h-256   l87.3-87.3c5-5,7.8-11.7,7.8-18.8c0-7.1-2.8-13.7-7.7-18.7c-10.1-10.1-27.5-10-37.5,0L75,255.6z",37,"rgb(144, 0, 255)","rgb(144, 0, 255, 0.7)","rgb(255, 255, 255, 0.5)","rgb(0, 0, 255, 0.7)",54,43),new e("M450.3,232c-23.7-23.7-62-23.7-85.7,0L316.6,280V60.6C316.6,27.1,289.4,0,256,0c-33.5,0-60.6,27.1-60.6,60.6V280L147.4,232   c-23.7-23.7-62-23.7-85.7,0c-23.7,23.7-23.7,62,0,85.7L256,512l194.3-194.3C474,294,474,255.7,450.3,232z","M256,512L67.2,323.2c-31-31-31-81.5,0-112.5c29-29,79-30.2,109.3-3V79.5C176.5,35.7,212.2,0,256,0s79.5,35.7,79.5,79.5   v128.2c30.3-27.1,80.3-26,109.3,3c31,31,31,81.5,0,112.5L256,512z M123.4,240.5c-7.1,0-13.7,2.8-18.7,7.8   c-10.4,10.3-10.4,27.1,0,37.5L256,437l151.3-151.3c10.4-10.4,10.4-27.1,0-37.5c-10-10-27.4-10-37.5,0l-87.3,87.3v-256   c0-14.6-11.9-26.5-26.5-26.5s-26.5,11.9-26.5,26.5v256l-87.3-87.3C137.2,243.2,130.5,240.5,123.4,240.5z",40,"rgb(0, 0, 255)","rgb(0, 0, 255, 0.7)","rgb(255, 255, 255, 0.5)","rgb(144, 0, 255, 0.7)",54,43),new e("M256,0L61.7,194.3C38,218,38,256.4,61.7,280c23.7,23.7,62,23.7,85.7,0l48.1-48.1v219.4c0,33.4,27.1,60.6,60.6,60.6   c33.4,0,60.6-27.1,60.6-60.6V232l48.1,48.1c11.9,11.9,27.3,17.8,42.8,17.8c15.5,0,31-5.9,42.8-17.8c23.7-23.7,23.7-62,0-85.7L256,0   z","M256,512c-44,0-79.8-35.8-79.8-79.8V305.4c-30.4,27.2-80.5,26-109.7-3.1c-31.1-31.1-31.1-81.8,0-112.9L256,0l189.5,189.5   c31.1,31.1,31.1,81.8,0,112.9c-29.1,29.1-79.3,30.3-109.7,3.1v126.8C335.8,476.2,300,512,256,512z M229.4,177.1v255.1   c0,14.7,11.9,26.6,26.6,26.6c14.7,0,26.6-12,26.6-26.6V177.1l87.6,87.6c10.1,10.1,27.5,10.1,37.6,0c10.4-10.4,10.4-27.2,0-37.6   L256,75.3L104.1,227.1c-10.4,10.4-10.4,27.2,0,37.6c10.1,10.1,27.5,10.1,37.6,0L229.4,177.1z",38,"rgb(255, 0, 44)","rgb(255, 0, 44, 0.7)","rgb(255, 255, 255, 0.5)","rgb(144, 0, 255, 0.7)",54,43),new e("M232,61.7c-23.7,23.6-23.7,62,0,85.7l48,48H60.6C27.1,195.4,0,222.5,0,256c0,33.4,27.1,60.6,60.6,60.6h219.5l-48,48   c-23.7,23.6-23.7,62,0,85.7c11.8,11.8,27.3,17.8,42.8,17.8c15.5,0,31-5.9,42.8-17.8L512,256L317.7,61.7C294,38,255.7,38,232,61.7z","M267,467.7c-21.2,0-41.2-8.3-56.2-23.3c-15-15-23.3-35-23.3-56.3c0-19.8,7.2-26.5,20.3-53H79.5C35.7,335.1,0,299.4,0,255.6   c0-43.8,35.7-79.5,79.5-79.5h128.2c-13.1-26.5-20.3-33.3-20.3-53c0-21.3,8.3-41.2,23.3-56.2c30-30,82.4-30,112.4,0L512,255.6   L323.2,444.4C308.2,459.4,288.2,467.7,267,467.7z M79.5,229.1C64.9,229.1,53,241,53,255.6c0,14.6,11.9,26.5,26.5,26.5h256   l-87.3,87.3c-5,5-7.8,11.6-7.8,18.7c0,7.1,2.8,13.8,7.8,18.8c10,10,27.4,10,37.5,0L437,255.6L285.7,104.3c-10-10-27.4-10-37.5,0   c-5,5-7.8,11.6-7.8,18.7c0,7.1,2.8,13.8,7.8,18.8l87.3,87.3H79.5z",39,"rgb(0, 255, 135)","rgb(0, 255, 135, 0.7)","rgb(255, 255, 255, 0.5)","rgb(144, 0, 255, 0.7)",54,43)];class r extends HTMLElement{constructor(){super()}connectedCallback(){this.render()}render(){this.innerHTML=`
        <style>
            #spinner {
                width: 100%;
                height: 100%;
                border: 16px solid #f3f3f3;
                border-top: 16px solid #ff7a91;
                border-radius: 50%;
                margin: 0 -16px;
                animation: spin 3s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        <div id="spinner"></div>
        `}}customElements.get("loading-spinner")||customElements.define("loading-spinner",r);class n{keyCodes=a.map(e=>e.keyCode);notes=[];appChart=null;player=null;get score(){}get currNoteIndices(){}get CurrentNoteIndex(){return Math.floor(c(this.appChart?.songTimeMs||0))}CurrentKeyDown(e){return e in this.currNoteIndices}constructor(e,t,s){this.notes=e,this.appChart=t,this.player=s}start(){}stop(){}updateScore(){}}class h extends n{good=0;great=0;missing=0;extra=0;inputHistory=[];lastUpdateScoreIndex=0;localScore=0;localCurrNoteIndices={};get currNoteIndices(){return this.localCurrNoteIndices}get score(){return this.localScore}set score(e){this.localScore=e}constructor(e,t,s){super(e,t,s),this.inputHistory=new Array(this.notes.length).fill(null).map(()=>[])}start(){this.registerEventListeners()}stop(){this.removeEventListeners()}checkNoteValid(t,e){return e<this.inputHistory.length&&this.keyCodes.includes(t)&&!this.inputHistory[e].some(e=>e.keyCode===t)}addCurrentNote(e,t){e in this.currNoteIndices||!this.checkNoteValid(e,t)||(this.currNoteIndices[e]=t)}pushCurrentNote(e,t){var s;e in this.currNoteIndices&&this.checkNoteValid(e,t)&&(s=this.currNoteIndices[e],this.inputHistory[s].push({keyCode:e,length:t-s+1}),delete this.currNoteIndices[e])}registerEventListeners(){this.keydownListener=e=>{this.addCurrentNote(e.keyCode,this.CurrentNoteIndex)},this.keyupListener=e=>{this.pushCurrentNote(e.keyCode,this.CurrentNoteIndex)},document.addEventListener("keydown",this.keydownListener),document.addEventListener("keyup",this.keyupListener)}removeEventListeners(){document.removeEventListener("keydown",this.keydownListener),document.removeEventListener("keyup",this.keyupListener)}updateScore(){for(var e=this.CurrentNoteIndex,t=this.lastUpdateScoreIndex;t<e&&t<this.notes.length;t++){let e=this.notes[t].slice(0),s=this.inputHistory[t].slice(0),i=0<=t-1?this.inputHistory[t-1].slice(0):[],a=0<=t-2?this.inputHistory[t-2].slice(0):[],r=0;for(;0<e.length;){let t=e.pop();s.some(e=>e.keyCode===t.keyCode)?(this.great+=1,r+=1):i.some(e=>e.keyCode===t.keyCode)||a.some(e=>e.keyCode===t.keyCode)?(this.good+=1,r+=1):this.missing+=1}this.extra+=s.length-r,this.score=12*this.great+10*this.good-2*this.missing-+this.extra}this.lastUpdateScoreIndex=e,this.player.update({score:this.score,currNoteIndices:this.currNoteIndices})}}class l extends n{get score(){return this.player.score||0}get currNoteIndices(){return this.player.currNoteIndices||{}}constructor(e,t,s){super(e,t,s)}start(){console.log("remote start")}stop(){console.log("remote stop")}updateScore(){console.log("remote update score")}}class d extends HTMLElement{get canvasHeight(){return this.offsetHeight-50}get canvasWidth(){return this.offsetWidth}get columnSize(){return this.offsetWidth/this.keys.length}get musicLength(){return o(this.notes.length)}get score(){return this.input?.score||0}get animationCallback(){return t=>e=>this.run(t,e)}get canvas(){return this.querySelector("canvas")}get context(){return this.canvas.getContext("2d")}get songTimeMs(){return this.animationStartDateNowMs-this.songStartDateNowMs+(this.lastAnimationMs-this.startAnimationMs)}constructor(){super(),this.reset()}setValues({isLocal:e,input:t}){this.isLocal=e,this.input=t}connectedCallback(){this.render(),this.rerender(),this.drawKeys()}reset(){this.notes=[],this.keys=a,this.lastAnimationMs=0,this.startAnimationMs=0,this.songStartDateNowMs=0,this.animationStartDateNowMs=0,this.isPlaying=!1,this.isLocal=!1,this.connectionManager=null,this.animationRequest=null}render(){this.innerHTML=`
            <canvas width="${this.canvasWidth}" height="${this.canvasHeight}"></canvas>
            <div id='score'>0</div>
        `}rerender(){this.isLocal&&this.setAttribute("class","local")}run(e,t=0){this.startAnimationMs||(this.startAnimationMs=t,this.animationStartDateNowMs=Date.now()),this.lastAnimationMs=t,this.update(this.songTimeMs)?this.animationRequest=requestAnimationFrame(this.animationCallback(e)):(console.log(this.lastAnimationMs-this.startAnimationMs),cancelAnimationFrame(this.animationRequest),this.input.stop(),e())}play(e,t=0){return this.songStartDateNowMs=t,this.notes=e,this.input.start(),this.isPlaying=!0,new Promise((e,t)=>{this.animationRequest=requestAnimationFrame(this.animationCallback(e))})}update(e){return!(e>=this.musicLength)&&(this.input.updateScore(),this.drawScore(),this.draw(e),!0)}drawKeys(){this.keys.forEach((e,t)=>{e=this.input.CurrentKeyDown(e.keyCode);this.drawKey(t,75,e)})}drawNote(e,t){var s=this.columnSize*(e+.5);this.keys[e].drawNote(this.context,s,t)}drawKey(e,t,s=!1){var i=this.columnSize*(e+.5);this.keys[e].drawKey(this.context,i,t,s)}drawLongNote(e,t,s){var i=this.columnSize*(e+.5);this.keys[e].drawLongNote(this.context,i,t,s)}drawNoteAt(t,e,s){var i,a=s,r=s+(i=this.canvas.height,o(i/45)),n=o(e),s=o(e+t.length),i=(i=a,e=n,45*c(e-i));r<n||s<a||(a=this.keys.findIndex(e=>e.keyCode===t.keyCode),1==t.length?this.drawNote(a,i):this.drawLongNote(a,i,t.length))}draw(s){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawKeys(),this.notes.forEach((e,t)=>e.forEach(e=>this.drawNoteAt(e,t,s)))}drawScore(){this.querySelector("#score").innerHTML=this.score}}customElements.get("app-chart")||customElements.define("app-chart",d);class p extends HTMLElement{playerManager=null;chart=[];songStartTimeMs=0;get flexContainer(){return this.shadow.querySelector("div.flex-container")}constructor(){super(),this.shadow=this.attachShadow({mode:"open"})}setValues({playerManager:e,chart:t,songStartTimeMs:s}){this.playerManager=e,this.chart=t,this.songStartTimeMs=s}connectedCallback(){this.render()}render(){this.shadow.innerHTML=`
        <style>
            :host, .flex-container {
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                position: absolute;
            }
            .flex-container {
                display: flex;
                align-items: center;
                flex-direction: row;
                justify-content: space-around;
            }
            app-chart {
                width: calc(32%);
                height: calc(90%);
                border: 1px solid grey;
            }
            app-chart.local {
                border: 2px solid white;
            }
        </style>
        <div class='flex-container'>
        </div>`}finishPlayCallback(){this.dispatchEvent(new CustomEvent("chart-page-play-stop",{bubbles:!0,cancelable:!1,composed:!0}))}createLocalChart(){let e=document.createElement("app-chart");e.setValues({isLocal:!0,input:new h(this.chart,e,this.playerManager.LocalPlayer)}),this.flexContainer.appendChild(e),e.play(this.chart,this.songStartTimeMs).then(()=>{this.finishPlayCallback()})}createRemoteCharts(){var e=this.playerManager.RemotePlayers[0];let t=document.createElement("app-chart");this.flexContainer.appendChild(t),t.setValues({isLocal:!1,input:new l(this.chart,t,e)}),t.play(this.chart,this.songStartTimeMs)}start(){this.createLocalChart(),this.createRemoteCharts()}remove(e){this.flexContainer.removeChild(e.element)}}customElements.get("chart-page")||customElements.define("chart-page",p);class u extends HTMLElement{setValues({numberPlayerBroadcast:e,finishedUpload:t}){this.numberPlayerBroadcast|=e,this.finishedUpload|=t,this.rerender()}get input(){return this.shadow.querySelector("input")}get readyButton(){return this.shadow.querySelector("button#ready")}get spinner(){return this.shadow.querySelector("loading-spinner")}get showReady(){return this.finishedUpload}get showSpinner(){return this.startedUpload&&!this.finishedUpload}get readyText(){return this.readyClicked?"waiting for second player":"ready"}constructor(){super(),this.reset(),this.shadow=this.attachShadow({mode:"open"})}connectedCallback(){this.render(),this.rerender(),this.registerEventListeners()}reset(){this.numberPlayerBroadcast=0,this.startedUpload=!1,this.finishedUpload=!1,this.readyClicked=!1}render(){this.shadow.innerHTML=`
        <style>
            :host, .flex-container {
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                position: absolute;
            }
            .flex-container {
                display: flex;
                align-items: center;
                flex-direction: column;
                justify-content: center;
            }
            .flex-container > * {
                margin-bottom: 10px;
            }
            .flex-container > input {
                padding: 3px;
                border: 1px solid white;
            }
            loading-spinner {
                height: 60px;
                width: 60px;
            }
        </style>
        <div class='flex-container'>
            <p>select a mp3</p>
            <input id="file-input" type="file"></input>
            <button id="ready"></button>
            <loading-spinner></loading-spinner>
        </div>`}rerender(){this.readyButton.hidden=!this.showReady,this.readyButton.textContent=this.readyText,this.spinner.hidden=!this.showSpinner}registerEventListeners(){this.input.onchange=e=>{this.startedUpload=!0,this.rerender();const t=new FileReader;for(var s of this.input.files)t.readAsArrayBuffer(s);t.onload=e=>{this.buffer=t.result,this.upload()}},this.readyButton.onclick=()=>{this.readyClicked=!0,this.rerender(),this.dispatchEvent(new CustomEvent("input-page-ready-click",{bubbles:!0,cancelable:!1,composed:!0}))}}upload(){this.dispatchEvent(new CustomEvent("input-page-file-upload",{bubbles:!0,cancelable:!1,composed:!0,detail:{buffer:this.buffer}}))}}customElements.get("input-page")||customElements.define("input-page",u);class g extends HTMLElement{localScore=0;enemyScore=0;setValues({localScore:e,enemyScore:t}){this.localScore=e,this.enemyScore=t}constructor(){super(),this.shadow=this.attachShadow({mode:"open"})}connectedCallback(){this.render()}reset(){this.localScore=0,this.enemyScore=0}render(){this.shadow.innerHTML=`
        <style>
            :host, .flex-container {
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                position: absolute;
            }
            .flex-container {
                display: flex;
                align-items: center;
                flex-direction: row;
                justify-content: center;
            }
            .flex-container > * {
                margin: 50px;
            }
            .flex-child {
                width: 100px;
            }
            .winner {
                animation: blink 1s ease-in infinite;
            }
            @keyframes blink {
                0% {
                    border: 6px dashed yellow;
                }
                100% {
                    border: 1px solid white;
                }
            }
            .loser {
                border: 1px solid grey;
            }
            .score {
                border-radius: 40%;
                padding: 20px;
            }
        </style>
        <div class='flex-container'>
            <div class='flex-child'>
                <div class='${this.localScore>this.enemyScore?"winner":"loser"} score'>${this.localScore}</div>
            </div>
            <div class='flex-child'>
                <div class='${this.enemyScore>this.localScore?"winner":"loser"} score'>${this.enemyScore}</div>
            </div>
        </div>`}}customElements.get("score-page")||customElements.define("score-page",g);class y{constructor(){this.fileBuffer=null,this.chart=[]}async uploadMp3(e,t){try{await fetch((s=e,i(`song/${s}`)),{method:"PUT",headers:{"Content-Type":"audio/mpeg"},body:t})}catch(e){alert("Please check file format (should be mp3) and size (20MB limit).")}var s}async downloadMp3(e){let t=await fetch((e=e,i(`songs/${e}.mp3`)),{method:"GET"});this.fileBuffer=await t.arrayBuffer()}async downloadChart(e){let t=await fetch((e=e,i(`charts/${e}.json`)),{method:"GET"});return this.chart=await t.json(),this.chart}async playMp3(){let e=new AudioContext;const t=e.createBufferSource();t.buffer=await e.decodeAudioData(this.fileBuffer),t.connect(e.destination),t.start()}}class m{constructor(e="",t){this.clientId=e,this.connectionManager=t,this.score=0}update({score:e}){this.score=e}}class f extends m{update({score:e,currNoteIndices:t}){super.update({score:e}),this.connectionManager.sendUpdate({score:e,currNoteIndices:t})}}class C extends m{constructor(e,t){super(e,t),this.connectionManager.setCallback({playerUpdate:this.update.bind(this)})}update({score:e,currNoteIndices:t}){super.update({score:e}),this.currNoteIndices=t}}class b{get LocalPlayer(){return this.localPlayer}get RemotePlayers(){return Object.values(this.remotePlayers)}constructor(){this.remotePlayers={},this.localPlayer=null}addLocal(e,t){this.localPlayer=new f(e,t)}addRemote(e,t){this.remotePlayers[e]=new C(e,t)}updateRemote({clientId:e,...t}){e in this.remotePlayers?this.remotePlayers[e].update(t):console.error("client id is not recognized")}removeRemote(e){delete this.remotePlayers[e]}}const w=["input-page","chart-page","score-page"];class k extends HTMLElement{pageIndex=0;connectionManager=new class{constructor(){this.playerManager=new b,this.conn=null,this.roomCode="",this.callbacks={}}isConnected(){return!!this.conn&&0<this.roomCode.length}setCallback({create:e,join:t,broadcast:s,songReady:i,roomReady:a,gameBroadcast:r}){this.callbacks={create:e,join:t,broadcast:s,songReady:i,roomReady:a,gameBroadcast:r,...this.callbacks}}connect(e=s){this.conn=new WebSocket(e),this.conn.addEventListener("open",()=>{this.initRoom()}),this.conn.addEventListener("message",e=>{console.log(`message: ${e.data}`);e=this.receive(e.data);"room-created"===e.type?(this.setRoom(e.roomCode),this.callbacks?.create&&this.callbacks.create(e)):"room-joined"===e.type?(this.setRoom(e.roomCode),this.callbacks?.join&&this.callbacks.join(e)):"room-broadcast"===e.type?(this.setPlayers(e.peers),this.callbacks?.broadcast&&this.callbacks.broadcast(e)):"song-ready"===e.type?this.callbacks?.songReady&&this.callbacks.songReady(e):"room-ready"===e.type?this.callbacks?.roomReady&&this.callbacks.roomReady(e):"game-broadcast"===e.type&&(this.playerManager.updateRemote(e),this.callbacks?.gameBroadcast&&this.callbacks.gameBroadcast(e))})}setPlayers(e){const t=e.you,s=e.peers.filter(e=>t!==e);this.playerManager.addLocal(t,this),s.forEach(e=>{this.playerManager.addRemote(e,this)})}receive(e){return JSON.parse(e)}send(e){e=JSON.stringify(e);console.log(`sending message ${e}`),this.conn.send(e)}sendCreate(){this.send({type:"create-room"})}sendJoin(){this.send({type:"join-room",roomCode:this.roomCode})}sendReady(){this.send({type:"ready",roomCode:this.roomCode})}sendUpdate({score:e,currNoteIndices:t}){this.send({type:"game-update",score:e,currNoteIndices:t})}sendFinish(){this.send({type:"game-finish"})}initRoom(){this.roomCode=window.location.hash.split("#")[1],this.roomCode?this.sendJoin():this.sendCreate()}setRoom(e){this.roomCode=e,window.location.hash=this.roomCode}};fileManager=new y;constructor(){super(),this.reset(),this.registerEventListeners()}connectedCallback(){this.render(),this.connectionManager.setCallback({broadcast:this.broadcastCallback.bind(this),songReady:this.songReadyCallback.bind(this),roomReady:this.roomReadyCallback.bind(this)}),this.connectionManager.connect()}reset(){this.pageIndex=0,this.localChart=[]}render(){this.innerHTML=`
            <div>
                ${0===this.pageIndex?"<input-page></input-page>":""}
                ${1===this.pageIndex?"<chart-page></chart-page>":""}
                ${2===this.pageIndex?"<score-page></score-page>":""}
            </div>
        `}getRef(e){return this.querySelector(e)}broadcastCallback({}){this.getRef("input-page")?.setValues({finishedBroadcast:!0})}async songReadyCallback({}){await Promise.all([this.fileManager.downloadChart(this.connectionManager.roomCode),this.fileManager.downloadMp3(this.connectionManager.roomCode)]),this.getRef("input-page")?.setValues({finishedUpload:!0})}async roomReadyCallback({}){await this.fileManager.playMp3();var e=Date.now();this.goNextPage(),this.getRef("chart-page")?.setValues({playerManager:this.connectionManager.playerManager,chart:this.fileManager.chart,songStartTimeMs:e}),this.getRef("chart-page")?.render(),this.getRef("chart-page")?.start()}registerEventListeners(){this.addEventListener("input-page-file-upload",this.onFileUploadClicked.bind(this)),this.addEventListener("input-page-ready-click",this.onReadyClicked.bind(this)),this.addEventListener("chart-page-play-stop",this.onPlayStopped.bind(this))}goNextPage(){this.pageIndex=this.pageIndex===w.length-1?this.pageIndex:this.pageIndex+1,this.render()}onFileUploadClicked({detail:{buffer:e}}){this.fileManager.uploadMp3(this.connectionManager.roomCode,e)}onReadyClicked({}){this.connectionManager.sendReady()}onPlayStopped({}){var e=this.connectionManager.playerManager.LocalPlayer.score,t=this.connectionManager.playerManager.RemotePlayers.map(e=>e.score);this.goNextPage(),this.getRef("score-page")?.setValues({localScore:e,enemyScore:t[0]}),this.getRef("score-page")?.render(),this.connectionManager.sendFinish()}}customElements.get("page-manager")||customElements.define("page-manager",k);